From 5599f108baaa956e9f2548faeba805e48a3dcdd5 Mon Sep 17 00:00:00 2001
From: Timon Sassor <timon.sassor@governikus.de>
Date: Tue, 14 Oct 2025 17:26:26 +0200
Subject: Android a11y Support text selection

Change-Id: I57d2047ae7230645e625283d7bf6e644bd137ba4
---
 .../qt/android/QtAccessibilityDelegate.java   |  68 ++++-
 .../qt/android/QtNativeAccessibility.java     |   9 +-
 src/gui/accessible/qaccessible.cpp            |   5 +-
 .../android/androidjniaccessibility.cpp       | 272 ++++++++++++++++--
 4 files changed, 320 insertions(+), 34 deletions(-)

diff --git x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtAccessibilityDelegate.java y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtAccessibilityDelegate.java
index 81db2da44d866e12c454af04f5e5c1d16ddf6f9b..8739ff96c965fc02471a5b6e5407ab4b5d536646 100644
--- x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtAccessibilityDelegate.java
+++ y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtAccessibilityDelegate.java
@@ -4,6 +4,8 @@
 
 package org.qtproject.qt.android;
 
+import android.content.ClipData;
+import android.content.ClipboardManager;
 import android.content.Context;
 import android.graphics.Rect;
 import android.os.Build;
@@ -44,6 +46,7 @@ class QtAccessibilityDelegate extends View.AccessibilityDelegate
     private int m_hoveredVirtualViewId = INVALID_ID;
 
     private int m_currentRotorSetting = AccessibilityNodeInfo.MOVEMENT_GRANULARITY_CHARACTER;
+    private int m_lastCursorMovement = AccessibilityNodeInfo.ACTION_NEXT_AT_MOVEMENT_GRANULARITY;
 
     // Cache coordinates of the view to know the global offset
     // this is because the Android platform window does not take
@@ -388,6 +391,13 @@ class QtAccessibilityDelegate extends View.AccessibilityDelegate
         if (eventType == AccessibilityEvent.TYPE_VIEW_TEXT_TRAVERSED_AT_MOVEMENT_GRANULARITY) {
             event.setMovementGranularity(m_currentRotorSetting);
             QtNativeAccessibility.populateGranularMovementEvent(virtualViewId, event);
+            event.setAction(m_lastCursorMovement);
+        }
+
+        if (eventType == AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED) {
+            QtNativeAccessibility.populateSelectionChangedEvent(virtualViewId, event);
+            String name = QtNativeAccessibility.textForAccessibleObject(virtualViewId);
+            event.getText().add(name);
         }
 
         return event;
@@ -514,6 +524,11 @@ class QtAccessibilityDelegate extends View.AccessibilityDelegate
                 AccessibilityNodeInfo.MOVEMENT_GRANULARITY_LINE |
                 AccessibilityNodeInfo.MOVEMENT_GRANULARITY_PARAGRAPH
             );
+
+            node.addAction(AccessibilityNodeInfo.AccessibilityAction.ACTION_SET_SELECTION);
+            node.addAction(AccessibilityNodeInfo.AccessibilityAction.ACTION_COPY);
+            node.addAction(AccessibilityNodeInfo.AccessibilityAction.ACTION_CUT);
+            node.addAction(AccessibilityNodeInfo.AccessibilityAction.ACTION_PASTE);
         }
 
         // Manage internal accessibility focus state.
@@ -621,10 +636,57 @@ class QtAccessibilityDelegate extends View.AccessibilityDelegate
                 AccessibilityNodeInfo.ACTION_ARGUMENT_MOVEMENT_GRANULARITY_INT,
                 AccessibilityNodeInfo.MOVEMENT_GRANULARITY_CHARACTER // Default-Value, if not set
             );
+            final boolean extendSelection = arguments.getBoolean(AccessibilityNodeInfo.ACTION_ARGUMENT_EXTEND_SELECTION_BOOLEAN, false);
             final boolean movingForward = action == AccessibilityNodeInfo.ACTION_NEXT_AT_MOVEMENT_GRANULARITY;
-            success = QtNativeAccessibility.moveToNextElementAtGranularity(virtualViewId, movingForward, m_currentRotorSetting);
-            if (success)
-                sendEventForVirtualViewId(virtualViewId, AccessibilityEvent.TYPE_VIEW_TEXT_TRAVERSED_AT_MOVEMENT_GRANULARITY);
+            success = QtNativeAccessibility.moveToNextElementAtGranularity(virtualViewId, movingForward, m_currentRotorSetting, extendSelection);
+            m_lastCursorMovement = action;
+            if (success) {
+                if (extendSelection) {
+                    sendEventForVirtualViewId(virtualViewId, AccessibilityEvent.TYPE_VIEW_TEXT_TRAVERSED_AT_MOVEMENT_GRANULARITY);
+                    sendEventForVirtualViewId(virtualViewId, AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED);
+                } else {
+                    sendEventForVirtualViewId(virtualViewId, AccessibilityEvent.TYPE_VIEW_TEXT_TRAVERSED_AT_MOVEMENT_GRANULARITY);
+                }
+            }
+            break;
+        case AccessibilityNodeInfo.ACTION_CUT:
+            {
+                ClipboardManager clipboardManager = (ClipboardManager)m_layout.getContext().getSystemService(Context.CLIPBOARD_SERVICE);
+                String text = QtNativeAccessibility.getSelectedText(virtualViewId);
+                success = QtNativeAccessibility.deleteSelectedText(virtualViewId);
+                if (!success) {
+                    break;
+                }
+                sendEventForVirtualViewId(virtualViewId, AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED);
+                ClipData clipData = ClipData.newPlainText("selected_text", text);
+                clipboardManager.setPrimaryClip(clipData);
+            }
+            break;
+        case AccessibilityNodeInfo.ACTION_COPY:
+            {
+                ClipboardManager clipboardManager = (ClipboardManager)m_layout.getContext().getSystemService(Context.CLIPBOARD_SERVICE);
+                String text = QtNativeAccessibility.getSelectedText(virtualViewId);
+                if (text.isEmpty())
+                    text = QtNativeAccessibility.textForAccessibleObject(virtualViewId);
+                ClipData clipData = ClipData.newPlainText("selected_text", text);
+                clipboardManager.setPrimaryClip(clipData);
+                success = true;
+            }
+            break;
+        case AccessibilityNodeInfo.ACTION_PASTE:
+            {
+                ClipboardManager clipboardManager = (ClipboardManager)m_layout.getContext().getSystemService(Context.CLIPBOARD_SERVICE);
+                if (!clipboardManager.hasPrimaryClip()) {
+                    break;
+                }
+                ClipData clipData = clipboardManager.getPrimaryClip();
+                if (clipData == null || clipData.getItemCount() <= 0) {
+                    break;
+                }
+                ClipData.Item item = clipData.getItemAt(0);
+                String text = item.coerceToText(m_layout.getContext()).toString();
+                success = QtNativeAccessibility.replaceSelectedText(virtualViewId, text);
+            }
             break;
         }
         return success;
diff --git x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtNativeAccessibility.java y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtNativeAccessibility.java
index 9074e589a779c0bf20c383f0cb0fd40642d49111..49075d92b5528759fa3cfc054a6e4a669bce6246 100644
--- x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtNativeAccessibility.java
+++ y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtNativeAccessibility.java
@@ -14,6 +14,7 @@ class QtNativeAccessibility
     static native int[] childIdListForAccessibleObject(int objectId);
     static native int parentId(int objectId);
     static native String descriptionForAccessibleObject(int objectId);
+    static native String textForAccessibleObject(int objectId);
     static native String appLanguage();
     static native Rect screenRect(int objectId);
     static native int hitTest(float x, float y);
@@ -21,9 +22,15 @@ class QtNativeAccessibility
     static native boolean focusAction(int objectId);
     static native boolean scrollForward(int objectId);
     static native boolean scrollBackward(int objectId);
-    static native boolean moveToNextElementAtGranularity(int objectId, boolean forward, int granularity);
+    static native boolean moveToNextElementAtGranularity(int objectId, boolean forward, int granularity, boolean extendSelection);
+    static native boolean setTextSelection(int objectId, int start, int end);
 
     static native boolean populateNode(int objectId, AccessibilityNodeInfo node);
     static native boolean populateScrollEvent(int objectId, AccessibilityEvent event);
     static native boolean populateGranularMovementEvent(int objectId, AccessibilityEvent event);
+    static native boolean populateSelectionChangedEvent(int objectId, AccessibilityEvent event);
+
+    static native boolean deleteSelectedText(int objectId);
+    static native String getSelectedText(int objectId);
+    static native boolean replaceSelectedText(int objectId, String newText);
 }
diff --git x/qtbase/src/gui/accessible/qaccessible.cpp y/qtbase/src/gui/accessible/qaccessible.cpp
index 919e2cc21fa569ba2d28e6aed2f62966952e8928..3b0a53bab3d9b41a099acea827080ee6cfa6861e 100644
--- x/qtbase/src/gui/accessible/qaccessible.cpp
+++ y/qtbase/src/gui/accessible/qaccessible.cpp
@@ -2366,10 +2366,7 @@ QString QAccessibleTextInterface::textAtOffset(int offset, QAccessible::TextBoun
         offset = txt.size();
 
     *startOffset = *endOffset = -1;
-    if (txt.isEmpty() || offset < 0 || offset > txt.size())
-        return QString();
-
-    if (offset == txt.size() && boundaryType == QAccessible::CharBoundary)
+    if (txt.isEmpty() || offset < 0 || offset >= txt.size())
         return QString();
 
     // type initialized just to silence a compiler warning [-Werror=maybe-uninitialized]
diff --git x/qtbase/src/plugins/platforms/android/androidjniaccessibility.cpp y/qtbase/src/plugins/platforms/android/androidjniaccessibility.cpp
index d1611aef02fc24f7b6fd38a4e29b2a2fa0079aaa..eb661f82134e1c2cbe46e6250a1b1a302ec87b4c 100644
--- x/qtbase/src/plugins/platforms/android/androidjniaccessibility.cpp
+++ y/qtbase/src/plugins/platforms/android/androidjniaccessibility.cpp
@@ -20,6 +20,7 @@
 #include <QtCore/qpointer.h>
 #include <QtCore/qvarlengtharray.h>
 #include <QLocale>
+#include <QtMinMax>
 
 static const char m_qtTag[] = "Qt A11Y";
 
@@ -42,6 +43,7 @@ namespace QtAndroidAccessibility
     static jmethodID m_setHeadingMethodID = 0;
     static jmethodID m_setScrollableMethodID = 0;
     static jmethodID m_setTextSelectionMethodID = 0;
+    static jmethodID m_setTextMethodID = 0;
     static jmethodID m_setRangeInfoMethodID = 0;
     static jmethodID m_setVisibleToUserMethodID = 0;
     static jmethodID m_setMaxScrollXMethodID = 0;
@@ -424,7 +426,10 @@ namespace QtAndroidAccessibility
         return result && oldPosition != screenRect_helper(firstChildId, false);
     }
 
-    static bool moveToNextElementAtGranularity_helper(int objectId, bool forward, int granularity)
+    static int oldCursorPosition = 0;
+    static int newCursorPosition = 0;
+
+    static bool moveToNextElementAtGranularity_helper(int objectId, bool forward, int granularity, bool extendSelection)
     {
         QAccessibleInterface *iface = interfaceFromId(objectId);
         if (!iface || !iface->isValid() || !iface->textInterface())
@@ -436,33 +441,163 @@ namespace QtAndroidAccessibility
         const auto movementGranularity = m_movementGranularityMapping.key(granularity, QAccessible::TextBoundaryType::NoBoundary);
         const int cursorPosition = textIface->cursorPosition();
         const int charCount = textIface->characterCount();
+
         const bool wouldMoveOutsideBounds = (!forward && cursorPosition == 0) || (forward && cursorPosition == charCount);
         if (movementGranularity == QAccessible::TextBoundaryType::NoBoundary || wouldMoveOutsideBounds)
             return false;
 
-        int fromIndex = 0;
-        int toIndex = 0;
-        if (forward)
+        int fromIndex = 0, toIndex = 0;
+        int currentSelectionStart = 0, currentSelectionEnd = 0;
+        textIface->selection(0, &currentSelectionStart, &currentSelectionEnd);
+        textIface->textAtOffset(cursorPosition, movementGranularity, &fromIndex, &toIndex);
+        if (forward && cursorPosition == toIndex) {
             textIface->textAfterOffset(cursorPosition, movementGranularity, &fromIndex, &toIndex);
-        else
+            toIndex = qMin(toIndex, charCount);
+        } else if (!forward && cursorPosition == fromIndex) {
             textIface->textBeforeOffset(cursorPosition, movementGranularity, &fromIndex, &toIndex);
+            fromIndex = qMax(fromIndex, 0);
+        } else if (!forward && cursorPosition == charCount) {
+            textIface->textAtOffset(cursorPosition - 1, movementGranularity, &fromIndex, &toIndex);
+            fromIndex = qMax(fromIndex, 0);
+        }
 
-        if (toIndex < 0)
-            textIface->setCursorPosition(charCount);
-        else if (fromIndex < 0)
-            textIface->setCursorPosition(0);
-        else
-            textIface->setCursorPosition(fromIndex);
+        oldCursorPosition = cursorPosition;
+
+        const bool cursorBeforeSelection = cursorPosition == currentSelectionStart;
+        if (extendSelection) {
+            if (forward && cursorBeforeSelection) {
+                textIface->setSelection(0, currentSelectionEnd, toIndex);
+                newCursorPosition = toIndex;
+            } else if (forward && !cursorBeforeSelection) {
+                textIface->setSelection(0, currentSelectionStart, toIndex);
+                newCursorPosition = toIndex;
+            } else if (!forward && cursorBeforeSelection) {
+                textIface->setSelection(0, currentSelectionEnd, fromIndex);
+                newCursorPosition = fromIndex;
+            } else if (!forward && !cursorBeforeSelection) {
+                textIface->setSelection(0, currentSelectionStart, fromIndex);
+                newCursorPosition = fromIndex;
+            }
+        } else {
+            textIface->setCursorPosition(forward ? toIndex : fromIndex);
+            newCursorPosition = forward ? toIndex : fromIndex;
+        }
 
         return true;
     }
 
-    static jboolean moveToNextElementAtGranularity(JNIEnv */*env*/, jobject /*thiz*/, jint objectId, jboolean forward, jint granularity)
+    static jboolean moveToNextElementAtGranularity(JNIEnv */*env*/, jobject /*thiz*/, jint objectId, jboolean forward, jint granularity, jboolean extendSelection)
     {
         bool result = false;
         if (m_accessibilityContext) {
-            runInObjectContext(m_accessibilityContext, [objectId, forward, granularity]() {
-                return moveToNextElementAtGranularity_helper(objectId, forward, granularity);
+            runInObjectContext(m_accessibilityContext, [objectId, forward, granularity, extendSelection]() {
+                return moveToNextElementAtGranularity_helper(objectId, forward, granularity, extendSelection);
+            }, &result);
+        }
+        return result;
+    }
+
+    static bool deleteSelectedText_helper(int objectId) {
+        QAccessibleInterface *iface = interfaceFromId(objectId);
+        if (!iface || !iface->isValid() || !iface->textInterface())
+            return false;
+
+        QAccessibleTextInterface *textIface = iface->textInterface();
+        QAccessibleEditableTextInterface *editTextIface = iface->editableTextInterface();
+        if (textIface && editTextIface && (textIface->selectionCount() > 0)) {
+            int selectionStart = 0, selectionEnd = 0;
+            textIface->selection(0, &selectionStart, &selectionEnd);
+            if (selectionStart < 0 || selectionEnd < 0) {
+                return false;
+            }
+            editTextIface->deleteText(selectionStart, selectionEnd);
+            return true;
+        }
+
+        return false;
+    }
+
+    static bool deleteSelectedText(JNIEnv */*env*/, jobject /*thiz*/, jint objectId) {
+        bool result = false;
+        if (m_accessibilityContext) {
+            runInObjectContext(m_accessibilityContext, [objectId]() {
+                return deleteSelectedText_helper(objectId);
+            }, &result);
+        }
+        return result;
+    }
+
+    static QString getSelectedText_helper(int objectId) {
+        QAccessibleInterface *iface = interfaceFromId(objectId);
+        if (!iface || !iface->isValid() || !iface->textInterface())
+            return QString();
+
+        QAccessibleTextInterface *textIface = iface->textInterface();
+        if (textIface && (textIface->selectionCount() > 0)) {
+            int selectionStart = 0, selectionEnd = 0;
+            textIface->selection(0, &selectionStart, &selectionEnd);
+            if (selectionStart < 0 || selectionEnd < 0) {
+                return QString();
+            }
+            return textIface->text(selectionStart, selectionEnd);
+        }
+
+        return QString();
+    }
+
+    static jstring getSelectedText(JNIEnv *env, jobject /*thiz*/, int objectId) {
+        QString text;
+        if (m_accessibilityContext) {
+            runInObjectContext(m_accessibilityContext, [objectId]() {
+                return getSelectedText_helper(objectId);
+            }, &text);
+        }
+        return env->NewString((jchar*) text.constData(), (jsize) text.size());
+    }
+
+
+    static bool replaceSelectedText_helper(int objectId, QString newText) {
+        QAccessibleInterface *iface = interfaceFromId(objectId);
+        if (!iface || !iface->isValid() || !iface->textInterface())
+            return false;
+
+        QAccessibleTextInterface *textIface = iface->textInterface();
+        QAccessibleEditableTextInterface *editTextIface = iface->editableTextInterface();
+
+        if (textIface && editTextIface) {
+            if (textIface->selectionCount() > 0) {
+                int selectionStart = 0, selectionEnd = 0;
+                textIface->selection(0, &selectionStart, &selectionEnd);
+                if (selectionStart < 0 || selectionEnd < 0)
+                    return false;
+
+                editTextIface->replaceText(selectionStart, selectionEnd, newText);
+                return true;
+            } else {
+                const int cursorPosition = textIface->cursorPosition();
+                const int charCount = textIface->characterCount();
+                if (cursorPosition < 0 || cursorPosition > charCount)
+                    return false;
+
+                editTextIface->insertText(cursorPosition, newText);
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    static bool replaceSelectedText(JNIEnv *env, jobject /*thiz*/, jint objectId, jstring newText) {
+        const char* utfChars = env->GetStringUTFChars(newText, nullptr);
+        if (!utfChars) {
+            return false;
+        }
+        QString convertedText = QString::fromUtf8(utfChars);
+        env->ReleaseStringUTFChars(newText, utfChars);
+        bool result = false;
+        if (m_accessibilityContext) {
+            runInObjectContext(m_accessibilityContext, [objectId, convertedText]() {
+                return replaceSelectedText_helper(objectId, convertedText);
             }, &result);
         }
         return result;
@@ -703,6 +838,24 @@ namespace QtAndroidAccessibility
         return env->NewString((jchar*) desc.constData(), (jsize) desc.size());
     }
 
+    static QString textForAccessibleObject_helper(int objectId)
+    {
+        QAccessibleInterface *iface = interfaceFromId(objectId);
+        QAccessibleTextInterface *textIface = iface->textInterface();
+        return textIface->text(0, textIface->characterCount());
+    }
+
+    static jstring textForAccessibleObject(JNIEnv *env, jobject /*thiz*/, jint objectId)
+    {
+        QString name;
+        if (m_accessibilityContext) {
+            runInObjectContext(m_accessibilityContext, [objectId]() {
+                return textForAccessibleObject_helper(objectId);
+            }, &name);
+        }
+        return env->NewString((jchar*) name.constData(), (jsize) name.size());
+    }
+
     static jstring appLanguage(JNIEnv *env, jobject /*thiz*/)
     {
         const QString localeName = QLocale().bcp47Name();
@@ -718,6 +871,7 @@ namespace QtAndroidAccessibility
         QString description;
         QString identifier;
         bool hasTextSelection = false;
+        QString text;
         int selectionStart = 0;
         int selectionEnd = 0;
         bool hasValue = false;
@@ -739,9 +893,14 @@ namespace QtAndroidAccessibility
             info.description = descriptionForInterface(iface);
             info.identifier = QAccessibleBridgeUtils::accessibleId(iface);
             QAccessibleTextInterface *textIface = iface->textInterface();
-            if (textIface && (textIface->selectionCount() > 0)) {
-                info.hasTextSelection = true;
-                textIface->selection(0, &info.selectionStart, &info.selectionEnd);
+            if (textIface) {
+                if (textIface->selectionCount() > 0) {
+                    info.hasTextSelection = true;
+                    textIface->selection(0, &info.selectionStart, &info.selectionEnd);
+                }
+                if (iface->role() == QAccessible::EditableText) {
+                    info.text = textIface->text(0, textIface->characterCount());
+                }
             }
             QAccessibleValueInterface *valueInterface = iface->valueInterface();
             if (valueInterface) {
@@ -782,6 +941,11 @@ namespace QtAndroidAccessibility
                 info.actions.contains(QAccessibleActionInterface::decreaseAction());
         const bool scrollableRole = info.role == QAccessible::ScrollBar || info.role == QAccessible::List;
 
+        if (!info.text.isEmpty()) {
+            jstring jtext = env->NewString((jchar*)info.text.constData(), (jsize)info.text.size());
+            env->CallVoidMethod(node, m_setTextMethodID, jtext);
+        }
+
         if (info.hasTextSelection && m_setTextSelectionMethodID) {
             env->CallVoidMethod(node, m_setTextSelectionMethodID, info.selectionStart,
                                 info.selectionEnd);
@@ -923,6 +1087,7 @@ namespace QtAndroidAccessibility
         bool valid = false;
         int fromIndex = 0;
         int toIndex = 0;
+        int characterCount = 0;
     };
 
     static GranularMovementEventInfo populateGranularMovementEvent_helper(int objectId, int movementGranularity)
@@ -940,13 +1105,9 @@ namespace QtAndroidAccessibility
 
         const auto mappedMovementGranularity = m_movementGranularityMapping.key(movementGranularity, QAccessible::TextBoundaryType::NoBoundary);
         if (mappedMovementGranularity != QAccessible::TextBoundaryType::NoBoundary) {
-            // Since this method is called after the cursor already moved, we only have to look left of the cursor.
-            textIface->textBeforeOffset(
-                textIface->cursorPosition(),
-                mappedMovementGranularity,
-                &info.fromIndex,
-                &info.toIndex
-            );
+            info.fromIndex = oldCursorPosition;
+            info.toIndex = newCursorPosition;
+            info.characterCount = abs(info.toIndex - info.fromIndex);
         }
 
         return info;
@@ -969,15 +1130,69 @@ namespace QtAndroidAccessibility
 
         env->CallVoidMethod(event, m_setFromIndexEventMethodID, info.fromIndex);
         env->CallVoidMethod(event, m_setToIndexEventMethodID, info.toIndex);
+        env->CallVoidMethod(event, m_setItemCountMethodID, info.characterCount);
 
         return true;
     }
 
+    struct SelectionChangedEventInfo
+    {
+        bool valid = false;
+        int fromIndex = 0;
+        int toIndex = 0;
+        int characterCount = 0;
+    };
+
+    static SelectionChangedEventInfo populateSelectionChangedEvent_helper(int objectId)
+    {
+        SelectionChangedEventInfo info;
+        QAccessibleInterface *iface = interfaceFromId(objectId);
+        if (!iface || !iface->isValid())
+            return info;
+
+            QAccessibleTextInterface *textIface = iface->textInterface();
+            if (!textIface)
+            return info;
+
+        info.valid = true;
+        textIface->selection(
+            0,
+            &info.fromIndex,
+            &info.toIndex
+        );
+        info.characterCount = info.toIndex - info.fromIndex;
+
+        return info;
+    }
+
+    static jboolean populateSelectionChangedEvent(JNIEnv *env, jobject /*thiz*/, jint objectId, jobject event)
+    {
+        SelectionChangedEventInfo info;
+        if (m_accessibilityContext) {
+            runInObjectContext(m_accessibilityContext, [objectId]() {
+                return populateSelectionChangedEvent_helper(objectId);
+            }, &info);
+        }
+        if (!info.valid) {
+            __android_log_print(ANDROID_LOG_WARN, m_qtTag, "Accessibility: populateSelectionChangedEvent for Invalid ID");
+            return false;
+        }
+
+        env->CallVoidMethod(event, m_setFromIndexEventMethodID, info.fromIndex);
+        env->CallVoidMethod(event, m_setToIndexEventMethodID, info.toIndex);
+        env->CallVoidMethod(event, m_setItemCountMethodID, info.characterCount);
+
+        return true;
+    }
+
+
+
     static const JNINativeMethod methods[] = {
         {"setActive","(Z)V",(void*)setActive},
         {"childIdListForAccessibleObject", "(I)[I", (jintArray)childIdListForAccessibleObject},
         {"parentId", "(I)I", (void*)parentId},
         {"descriptionForAccessibleObject", "(I)Ljava/lang/String;", (jstring)descriptionForAccessibleObject},
+        {"textForAccessibleObject", "(I)Ljava/lang/String;", (jstring)textForAccessibleObject},
         {"appLanguage", "()Ljava/lang/String;", (jstring)appLanguage},
         {"screenRect", "(I)Landroid/graphics/Rect;", (jobject)screenRect},
         {"hitTest", "(FF)I", (void*)hitTest},
@@ -987,8 +1202,12 @@ namespace QtAndroidAccessibility
         {"focusAction", "(I)Z", (void*)focusAction},
         {"scrollForward", "(I)Z", (void*)scrollForward},
         {"scrollBackward", "(I)Z", (void*)scrollBackward},
-        {"moveToNextElementAtGranularity", "(IZI)Z", (void *)moveToNextElementAtGranularity},
-        {"populateGranularMovementEvent", "(ILandroid/view/accessibility/AccessibilityEvent;)Z", (void *)populateGranularMovementEvent}
+        {"moveToNextElementAtGranularity", "(IZIZ)Z", (void *)moveToNextElementAtGranularity},
+        {"populateGranularMovementEvent", "(ILandroid/view/accessibility/AccessibilityEvent;)Z", (void *)populateGranularMovementEvent},
+        {"populateSelectionChangedEvent", "(ILandroid/view/accessibility/AccessibilityEvent;)Z", (void *)populateSelectionChangedEvent},
+        {"deleteSelectedText", "(I)Z", (void*)deleteSelectedText},
+        {"getSelectedText", "(I)Ljava/lang/String;", (jstring)getSelectedText},
+        {"replaceSelectedText", "(ILjava/lang/String;)Z", (void*)replaceSelectedText}
     };
 
 #define GET_AND_CHECK_STATIC_METHOD(VAR, CLASS, METHOD_NAME, METHOD_SIGNATURE) \
@@ -1023,6 +1242,7 @@ namespace QtAndroidAccessibility
         GET_AND_CHECK_STATIC_METHOD(m_setScrollableMethodID, nodeInfoClass, "setScrollable", "(Z)V");
         GET_AND_CHECK_STATIC_METHOD(m_setVisibleToUserMethodID, nodeInfoClass, "setVisibleToUser", "(Z)V");
         GET_AND_CHECK_STATIC_METHOD(m_setTextSelectionMethodID, nodeInfoClass, "setTextSelection", "(II)V");
+        GET_AND_CHECK_STATIC_METHOD(m_setTextMethodID, nodeInfoClass, "setText", "(Ljava/lang/CharSequence;)V");
         GET_AND_CHECK_STATIC_METHOD(
                 m_setRangeInfoMethodID, nodeInfoClass, "setRangeInfo",
                 "(Landroid/view/accessibility/AccessibilityNodeInfo$RangeInfo;)V");
