From 7d9ff000f34b1906900ca6e82d46fe88c0221e0b Mon Sep 17 00:00:00 2001
From: Jan Moeller <Jan.Moeller@governikus.de>
Date: Mon, 22 Sep 2025 11:44:08 +0200
Subject: Revert "Android-Keyboard: Use new show() / hide() methods for
 keyboard control"

This reverts commit 2aae64c041e81f7c982b3d3a72fc78ea7ce00a5a.

Change-Id: I68729f6b91bf02083d49e883439ea18f9e97c823
---
 .../qtproject/qt/android/QtInputDelegate.java | 119 ++++++------------
 1 file changed, 40 insertions(+), 79 deletions(-)

diff --git x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
index b0f0064230710b5445912dbaa96ea7d1a05d1a6d..9536ca920de096eaa40558e00ade52a957af4eaa 100644
--- x/qtbase/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
+++ y/qtbase/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
@@ -19,8 +19,6 @@ import android.view.KeyEvent;
 import android.view.MotionEvent;
 import android.view.WindowInsets;
 import android.view.WindowInsets.Type;
-import android.view.WindowInsetsAnimationController;
-import android.view.WindowInsetsAnimationControlListener;
 import android.view.WindowManager;
 import android.view.View;
 import android.view.ViewTreeObserver;
@@ -142,57 +140,6 @@ class QtInputDelegate implements QtInputConnection.QtInputConnectionListener, Qt
         }
     }
 
-    private void showKeyboard(Activity activity,
-                              final int x, final int y, final int width, final int height,
-                              final int inputHints, final int enterKeyType)
-    {
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
-            activity.getWindow().getInsetsController().controlWindowInsetsAnimation(
-                WindowInsets.Type.ime(), -1, null, null,
-                    new WindowInsetsAnimationControlListener() {
-                        @Override
-                        public void onCancelled(WindowInsetsAnimationController controller) { }
-
-                        @Override
-                        public void onReady(WindowInsetsAnimationController controller, int types) { }
-
-                        @Override
-                        public void onFinished(WindowInsetsAnimationController controller) {
-                            QtNativeInputConnection.updateCursorPosition();
-                            if (m_softInputMode == 0)
-                                probeForKeyboardHeight(activity, x, y, width, height,
-                                                       inputHints, enterKeyType);
-                        }
-                    });
-            activity.getWindow().getInsetsController().show(Type.ime());
-        } else {
-            if (m_imm == null)
-                return;
-            m_imm.showSoftInput(m_currentEditText, 0, new ResultReceiver(new Handler()) {
-                @Override
-                @SuppressWarnings("fallthrough")
-                protected void onReceiveResult(int resultCode, Bundle resultData) {
-                    switch (resultCode) {
-                        case InputMethodManager.RESULT_SHOWN:
-                            QtNativeInputConnection.updateCursorPosition();
-                            //FALLTHROUGH
-                        case InputMethodManager.RESULT_UNCHANGED_SHOWN:
-                            setKeyboardVisibility(true, System.nanoTime());
-                            if (m_softInputMode == 0) {
-                                probeForKeyboardHeight(activity,
-                                        x, y, width, height, inputHints, enterKeyType);
-                            }
-                            break;
-                        case InputMethodManager.RESULT_HIDDEN:
-                        case InputMethodManager.RESULT_UNCHANGED_HIDDEN:
-                            setKeyboardVisibility(false, System.nanoTime());
-                            break;
-                    }
-                }
-            });
-        }
-    }
-
     @Override
     public void showSoftwareKeyboard(Activity activity,
                                      final int x, final int y, final int width, final int height,
@@ -212,7 +159,30 @@ class QtInputDelegate implements QtInputConnection.QtInputConnectionListener, Qt
             m_currentEditText.setLayoutParams(new QtLayout.LayoutParams(width, height, x, y));
             m_currentEditText.requestFocus();
             m_currentEditText.postDelayed(() -> {
-                showKeyboard(activity, x, y, width, height, inputHints, enterKeyType);
+                if (m_imm == null)
+                    return;
+                m_imm.showSoftInput(m_currentEditText, 0, new ResultReceiver(new Handler()) {
+                    @Override
+                    @SuppressWarnings("fallthrough")
+                    protected void onReceiveResult(int resultCode, Bundle resultData) {
+                        switch (resultCode) {
+                            case InputMethodManager.RESULT_SHOWN:
+                                QtNativeInputConnection.updateCursorPosition();
+                                //FALLTHROUGH
+                            case InputMethodManager.RESULT_UNCHANGED_SHOWN:
+                                setKeyboardVisibility(true, System.nanoTime());
+                                if (m_softInputMode == 0) {
+                                    probeForKeyboardHeight(activity,
+                                            x, y, width, height, inputHints, enterKeyType);
+                                }
+                                break;
+                            case InputMethodManager.RESULT_HIDDEN:
+                            case InputMethodManager.RESULT_UNCHANGED_HIDDEN:
+                                setKeyboardVisibility(false, System.nanoTime());
+                                break;
+                        }
+                    }
+                });
                 if (m_currentEditText.m_optionsChanged) {
                     m_imm.restartInput(m_currentEditText);
                     m_currentEditText.m_optionsChanged = false;
@@ -271,31 +241,22 @@ class QtInputDelegate implements QtInputConnection.QtInputConnectionListener, Qt
             if (m_imm == null || m_currentEditText == null)
                 return;
 
-            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
-                Activity activity = QtNative.activity();
-                if (activity == null) {
-                    Log.w(TAG, "hideSoftwareKeyboard: The activity reference is null");
-                    return;
-                }
-                activity.getWindow().getInsetsController().hide(Type.ime());
-            } else {
-                m_imm.hideSoftInputFromWindow(m_currentEditText.getWindowToken(), 0,
-                        new ResultReceiver(new Handler()) {
-                            @Override
-                            protected void onReceiveResult(int resultCode, Bundle resultData) {
-                                switch (resultCode) {
-                                    case InputMethodManager.RESULT_SHOWN:
-                                    case InputMethodManager.RESULT_UNCHANGED_SHOWN:
-                                        setKeyboardVisibility(true, System.nanoTime());
-                                        break;
-                                    case InputMethodManager.RESULT_HIDDEN:
-                                    case InputMethodManager.RESULT_UNCHANGED_HIDDEN:
-                                        setKeyboardVisibility(false, System.nanoTime());
-                                        break;
-                                }
+            m_imm.hideSoftInputFromWindow(m_currentEditText.getWindowToken(), 0,
+                    new ResultReceiver(new Handler()) {
+                        @Override
+                        protected void onReceiveResult(int resultCode, Bundle resultData) {
+                            switch (resultCode) {
+                                case InputMethodManager.RESULT_SHOWN:
+                                case InputMethodManager.RESULT_UNCHANGED_SHOWN:
+                                    setKeyboardVisibility(true, System.nanoTime());
+                                    break;
+                                case InputMethodManager.RESULT_HIDDEN:
+                                case InputMethodManager.RESULT_UNCHANGED_HIDDEN:
+                                    setKeyboardVisibility(false, System.nanoTime());
+                                    break;
                             }
-                        });
-            }
+                        }
+                    });
         });
     }
 
@@ -321,7 +282,7 @@ class QtInputDelegate implements QtInputConnection.QtInputConnectionListener, Qt
             return true;
         }
 
-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.R) {
+        if (android.os.Build.VERSION.SDK_INT < Build.VERSION_CODES.R) {
             Rect r = new Rect();
             activity.getWindow().getDecorView().getWindowVisibleDisplayFrame(r);
             DisplayMetrics metrics = new DisplayMetrics();
