name: Android Build

on:
  push:
    branches: [ community ]
  pull_request:
    branches: [ community ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build_android:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi: [armeabi-v7a, arm64-v8a]  # 支持多架构

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install "ndk;26.3.11579264"
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platforms;android-34"
          sdkmanager --install "platform-tools"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config python3 python3-pip openssl libssl-dev

      - name: Install Qt for Linux (host tools)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtscxml qtwebsockets qtshadertools qtconnectivity'
          setup-python: 'false'
          cache: true

      - name: Install Qt for Android (arm64-v8a)
        if: matrix.abi == 'arm64-v8a'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'linux'
          target: 'android'
          arch: 'android_arm64_v8a'
          modules: 'qtscxml qtwebsockets qtshadertools qtconnectivity'
          setup-python: 'false'
          cache: true

      - name: Install Qt for Android (armeabi-v7a)
        if: matrix.abi == 'armeabi-v7a'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'linux'
          target: 'android'
          arch: 'android_armv7'
          modules: 'qtscxml qtwebsockets qtshadertools qtconnectivity'
          setup-python: 'false'
          cache: true

      - name: Set environment variables
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/26.3.11579264" >> $GITHUB_ENV
          echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
          # Find Qt installation paths
          QT_ROOT=$(find ${{ github.workspace }}/Qt -type d -name "6.7.3" | head -1)
          QT_HOST_PATH="$QT_ROOT/gcc_64"
          if [ "${{ matrix.abi }}" == "arm64-v8a" ]; then
            QT_ANDROID_PATH="$QT_ROOT/android_arm64_v8a"
          else
            QT_ANDROID_PATH="$QT_ROOT/android_armv7"
          fi
          echo "QT_HOST_PATH=$QT_HOST_PATH" >> $GITHUB_ENV
          echo "Qt6_DIR=$QT_ANDROID_PATH" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$QT_ANDROID_PATH" >> $GITHUB_ENV
          echo "Qt host path: $QT_HOST_PATH"
          echo "Qt Android path: $QT_ANDROID_PATH"

      - name: Configure AusweisApp
        run: |
          mkdir -p build-android
          cd build-android
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/cmake/android.toolchain.cmake \
                -DCMAKE_ANDROID_ARCH_ABI=${{ matrix.abi }} \
                -DQT_HOST_PATH=$QT_HOST_PATH \
                -DCMAKE_PREFIX_PATH=$Qt6_DIR \
                -DCMAKE_FIND_ROOT_PATH=$Qt6_DIR \
                ..

      - name: Build APK
        run: |
          cd build-android
          cmake --build . --config Release -j$(nproc) || true
          
      - name: List build output
        if: always()
        run: |
          echo "=== Build directory structure ==="
          find build-android -type f -name "*.apk" -o -name "*.aab" || true
          echo "=== CMake cache ==="
          cat build-android/CMakeCache.txt | grep -E "(Qt|ANDROID|NDK)" || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v5
        with:
          name: AusweisApp-${{ matrix.abi }}-${{ github.sha }}
          path: build-android/*.apk
          retention-days: 30

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: build-logs-${{ matrix.abi }}
          path: |
            build-android/CMakeFiles/*.log
            build-android/CMakeCache.txt
